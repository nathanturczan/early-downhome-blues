<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0BFTP87KL1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0BFTP87KL1');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Early Downhome Blues - Melody Generator</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="stylesheet" href="https://use.typekit.net/zex5snw.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/tone@14"></script>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, query, where, getDocs, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBiTTX24mBjypGdel2ARBx0UUvFQEaRDf4",
            authDomain: "scale-navigator-ensemble.firebaseapp.com",
            projectId: "scale-navigator-ensemble",
            storageBucket: "scale-navigator-ensemble.appspot.com",
            messagingSenderId: "156837833740",
            appId: "1:156837833740:web:ce00fcf2297f899f8b9229"
        };

        const app = initializeApp(firebaseConfig);
        window.firebaseAuth = getAuth(app);
        window.firebaseDb = getFirestore(app);
        window.firebaseGoogleProvider = new GoogleAuthProvider();
        window.firebaseFunctions = {
            signInWithPopup, signOut, onAuthStateChanged,
            collection, addDoc, doc, getDoc, updateDoc, query, where, getDocs, onSnapshot
        };
    </script>
</head>
<body class="midi-minimized">
    <div class="header">
        <img src="icon.png" alt="Blues" class="header-icon">
        <div class="header-text">
            <h1>
                <span class="title-early-downhome">Early Downhome</span>
                <span class="title-blues">Blues</span>
            </h1>
            <p class="subtitle">Walking the Blues Scale</p>
        </div>
        <button id="ensemble-btn" class="ensemble-btn" type="button" aria-label="Ensemble Mode">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                <polygon points="12,2 22,8 22,16 12,22 2,16 2,8" fill="none" stroke="currentColor" stroke-width="1.5"/>
            </svg>
        </button>
        <button id="score-btn" class="score-btn" type="button" aria-label="View Score">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                <line x1="4" y1="7" x2="20" y2="7" stroke="currentColor" stroke-width="1"/>
                <line x1="4" y1="10" x2="20" y2="10" stroke="currentColor" stroke-width="1"/>
                <line x1="4" y1="13" x2="20" y2="13" stroke="currentColor" stroke-width="1"/>
                <line x1="4" y1="16" x2="20" y2="16" stroke="currentColor" stroke-width="1"/>
                <line x1="4" y1="19" x2="20" y2="19" stroke="currentColor" stroke-width="1"/>
                <ellipse cx="8" cy="8.5" rx="2.5" ry="2" fill="currentColor"/>
                <ellipse cx="14" cy="14.5" rx="2.5" ry="2" fill="currentColor"/>
            </svg>
        </button>
        <button id="info-btn" class="info-btn" type="button" aria-label="Information">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                <text x="12" y="17" text-anchor="middle" fill="currentColor" font-size="14" font-family="Georgia, serif" font-style="italic">i</text>
            </svg>
        </button>
        <button id="audio-toggle" class="audio-toggle is-off" type="button" aria-label="Toggle audio">
            <svg class="audio-icon" viewBox="50 120 600 820" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                <g transform="matrix(-1 0 0 -1 669.57 1049.9)">
                    <path
                        style="stroke-linejoin:round;fill-rule:evenodd;stroke:currentColor;stroke-linecap:round;stroke-width:5.9241;fill:currentColor"
                        d="m326.09 223.84c-26.945 0.30383-53.516 9.6369-76.656 23.562-34.633 18.379-71.629 47.097-72.875 89.906-0.84896 68.928-2.0988 134.26-2.2246 197.3-0.0684 34.285 0.19552 67.896 1.0371 101.04 0.71813 61.747 1.2222 123.5 1.4375 185.25 0.36593 12.973 21.473 16.135 26.438 4.6562 14.32-21.136 21.703-46.746 40.156-65 21.135-27.835 48.151-50.895 69.094-79.062 15.157-19.681 26.545-42.15 36.062-65.344 11.587-31.757 6.5491-67.411-5.8125-98.5-11.861-19.893-22.966-1.3151-19.072 12.118 4.1143 42.042-18.613 104.69-44.428 131.13-16.772 14.701-35.806 47.091-61.375 35.938-16.885-10.637-9.5264-32.115-11.344-48.688-0.3713-37.723-1.0624-80.647-0.84375-113.19 0.21869-32.541 1.4447-57.469 2.3125-108.38 2.3903-17.098 7.7188-34.867 26.875-28.812 39.201 14.915 85.221 10.405 121.62-10.344 37.084-16.471 67.22-55.32 65-97.031-0.69789-35.974-35.165-60.27-68.469-63.688-8.9535-2.0687-17.956-2.9763-26.938-2.875z"
                        transform="matrix(-1 0 0 -1 595.49 1051.9)"
                    />
                </g>
                <line class="audio-slash" x1="110" y1="170" x2="634" y2="882" stroke="currentColor" stroke-width="40" stroke-linecap="round"/>
            </svg>
        </button>
    </div>

    <div class="main-content">
        <div class="top-row">
            <div class="left-panel">
                <div class="notation-container">
                    <div id="notation"></div>
                </div>

                <div class="controls">
                    <div class="note-box current">
                        <span class="note-box-label">Current Note</span>
                        <div class="note-display">
                            <div class="current-note" id="currentNote">g</div>
                            <div class="note-info" id="noteInfo">392.00 Hz</div>
                        </div>
                    </div>
                    <div class="note-box paths">
                        <span class="note-box-label">Paths</span>
                        <div class="paths-box">
                            <div class="paths-notes" id="pathsNotes"></div>
                            <button id="nextBtn">Random</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Harmony Section -->
            <div class="drone-section">
            <div class="drone-header">
                <div class="drone-title">Harmony</div>
                <div class="inflect-toggles">
                    <div class="inflect-toggle">
                        <input type="checkbox" id="inflectToggle">
                        <label for="inflectToggle">Inflect</label>
                    </div>
                    <div class="inflect-toggle">
                        <input type="checkbox" id="latchToggle" disabled>
                        <label for="latchToggle" class="disabled">Latch</label>
                    </div>
                </div>
            </div>
            <div class="harmony-buttons">
                <button class="chord-btn" data-chord="I">I</button>
                <button class="chord-btn" data-chord="IV">IV</button>
                <button class="chord-btn" data-chord="V">V</button>
            </div>
        </div>
        </div>
        <!-- end top-row -->

        <div class="history">
            <h3>History</h3>
            <div class="history-notes" id="history"></div>
        </div>

        <!-- Phrasing toggles (outside stanza box) -->
        <div class="phrasing-toggles">
            <div class="phrasing-toggle">
                <input type="checkbox" id="phrasingToggle" checked>
                <label for="phrasingToggle">Phrasing</label>
            </div>
            <div class="phrasing-toggle">
                <input type="checkbox" id="autoHarmonyToggle">
                <label for="autoHarmonyToggle">Auto Harmony</label>
            </div>
            <div class="phrasing-toggle">
                <label for="harmonyModeSelect">Mode:</label>
                <select id="harmonyModeSelect" class="harmony-mode-select">
                    <option value="functional" selected>Full I-IV-V</option>
                    <option value="root-only">Root Only</option>
                    <option value="static-i">Static I</option>
                </select>
            </div>
        </div>

        <!-- Phase 2: Stanza Position Indicator -->
        <div class="stanza-indicator" id="stanzaIndicator">
            <span class="stanza-box-label">Stanza <span id="stanzaNumber">1</span></span>
            <div class="stanza-line" data-line="1">
                <span class="line-label">Line 1</span>
                <span class="line-harmony">I</span>
                <span class="phrase-box" data-phrase="a">phrase a</span>
                <span class="phrase-box" data-phrase="b">phrase b</span>
            </div>
            <div class="stanza-line" data-line="2">
                <span class="line-label">Line 2</span>
                <span class="line-harmony">IV-I</span>
                <span class="phrase-box" data-phrase="c">phrase c</span>
                <span class="phrase-box" data-phrase="d">phrase d</span>
            </div>
            <div class="stanza-line" data-line="3">
                <span class="line-label">Line 3</span>
                <span class="line-harmony">V-IV-I</span>
                <span class="phrase-box" data-phrase="e">phrase e</span>
                <span class="phrase-box" data-phrase="f">phrase f</span>
            </div>
            <div class="stanza-progress">
                <div class="phrase-progress-bar" id="phraseProgressBar">
                    <div class="phrase-progress-fill" id="phraseProgressFill"></div>
                </div>
            </div>
        </div>

        <div class="description-wrapper">
            <p class="description">
                Randomly walk through Jeff Todd Titon's pitch network from
                <em>Early Downhome Blues</em> (Fig. 64). Click notes or use the button to explore the mode.
            </p>
        </div>
    </div>

    <!-- MIDI Footer -->
    <div class="midi-footer minimized">
        <button class="midi-toggle" id="midiToggle" title="Toggle MIDI panel">
            <span class="midi-toggle-label">MIDI</span>
            <span class="midi-toggle-arrow">&#9660;</span>
        </button>
        <div class="midi-section">
            <div class="midi-outputs" id="midiOutputs">
                <div class="midi-row" data-row-id="0">
                    <div class="midi-select">
                        <label>Type</label>
                        <select class="midi-type">
                            <option value="melody" selected>Melody</option>
                            <option value="drone">Drone</option>
                        </select>
                    </div>
                    <div class="midi-select">
                        <label>Port</label>
                        <select class="midi-port">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div class="midi-select">
                        <label>Ch</label>
                        <select class="midi-channel">
                            <option value="0">1</option>
                            <option value="1">2</option>
                            <option value="2">3</option>
                            <option value="3">4</option>
                            <option value="4">5</option>
                            <option value="5">6</option>
                            <option value="6">7</option>
                            <option value="7">8</option>
                            <option value="8">9</option>
                            <option value="9">10</option>
                            <option value="10">11</option>
                            <option value="11">12</option>
                            <option value="12">13</option>
                            <option value="13">14</option>
                            <option value="14">15</option>
                            <option value="15">16</option>
                        </select>
                    </div>
                    <button class="midi-remove-btn hidden" title="Remove">&times;</button>
                </div>
            </div>
            <button class="midi-add-btn" id="addMidiOutput">+ Add Output</button>
        </div>
        <span class="midi-hint">*Pitch bend Â±2 semitones for quarter-tones</span>
    </div>

    <!-- Ensemble Modal -->
    <div id="ensemble-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content ensemble-modal-content">
            <button class="modal-close" aria-label="Close">&times;</button>
            <h2>Ensemble Mode</h2>

            <!-- Not signed in state -->
            <div id="ensemble-signed-out" class="ensemble-section">
                <p>Sign in to create or join an ensemble room.</p>
                <button id="google-sign-in-btn" class="sign-in-btn">
                    <svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>

            <!-- Signed in state -->
            <div id="ensemble-signed-in" class="ensemble-section hidden">
                <p class="logged-in-text">Logged in as <strong id="user-display-name"></strong></p>
                <button id="sign-out-btn" class="sign-out-btn">Sign out</button>

                <div class="ensemble-divider"></div>

                <!-- Host controls -->
                <div class="ensemble-control-group">
                    <label>Control existing ensemble:</label>
                    <select id="ensemble-select">
                        <option value="">Select existing ensemble</option>
                    </select>
                </div>

                <div class="ensemble-control-group">
                    <label>Create new ensemble:</label>
                    <div class="ensemble-create-row">
                        <input type="text" id="new-ensemble-name" placeholder="Name your ensemble">
                        <button id="create-ensemble-btn">Create</button>
                    </div>
                </div>

                <div class="ensemble-divider"></div>

                <!-- Join controls -->
                <div class="ensemble-control-group">
                    <label>Join ensemble as member:</label>
                    <div class="ensemble-create-row">
                        <input type="text" id="join-room-id" placeholder="Enter room ID">
                        <button id="join-ensemble-btn">Join</button>
                    </div>
                </div>

                <!-- Active ensemble status -->
                <div id="active-ensemble" class="active-ensemble hidden">
                    <div class="ensemble-divider"></div>
                    <div class="active-ensemble-header">
                        <span class="active-label">Active:</span>
                        <strong id="active-ensemble-name"></strong>
                        <span id="active-ensemble-role" class="ensemble-role"></span>
                    </div>
                    <button id="leave-ensemble-btn" class="leave-btn">Leave</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <button class="modal-close" aria-label="Close">&times;</button>
            <h2>About This App</h2>
            <p>This interactive tool lets you explore the <strong>pitch transition network</strong> from Jeff Todd Titon's influential book <em>Early Downhome Blues: A Musical and Cultural Analysis</em> (Figure 64).</p>

            <h3>The Network</h3>
            <p>Titon analyzed early blues recordings and mapped how melodies move between notes. This network captures those patterns, including:</p>
            <ul>
                <li><strong>Quarter-tones</strong> &mdash; The "blue third" (E quarter-flat) sits between E&#9837; and E</li>
                <li><strong>Sink note</strong> &mdash; C4 is the only resolution point with no outgoing paths</li>
                <li><strong>Hub note</strong> &mdash; G4 connects to the most destinations (6 notes)</li>
            </ul>

            <h3>How to Use</h3>
            <ul>
                <li><strong>Click notes</strong> on the staff or in the Paths box to navigate</li>
                <li><strong>Random</strong> picks a random valid next note</li>
                <li><strong>I / IV / V</strong> play chord drones; click again to stop. Check "Inflect" to bend pitches with the melody</li>
                <li><strong>MIDI Output</strong> sends notes to external instruments (set pitch bend to &plusmn;2 semitones)</li>
            </ul>

            <h3>Reference</h3>
            <p>Titon, Jeff Todd. <em>Early Downhome Blues: A Musical and Cultural Analysis</em>. 2nd ed., University of North Carolina Press, 1994.</p>
        </div>
    </div>

    <!-- Score History Modal -->
    <div id="score-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content score-modal-content">
            <button class="modal-close" aria-label="Close">&times;</button>
            <h2>Score</h2>
            <div class="score-container">
                <div id="score-canvas"></div>
            </div>
            <div class="export-panel">
                <button class="export-btn" data-format="lilypond">Export LilyPond</button>
                <button class="export-btn" data-format="musicxml">Export MusicXML</button>
                <button class="export-btn" data-format="pdf">Export PDF</button>
            </div>
        </div>
    </div>

    <script type="module" src="js/app.js"></script>
</body>
</html>
